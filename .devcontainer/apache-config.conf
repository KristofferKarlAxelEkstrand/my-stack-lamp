<VirtualHost *:80>
    ServerAdmin webmaster@localhost
    DocumentRoot /var/www/html/public
    
    <Directory /var/www/html/public>
        AllowOverride All
        Require all granted
        
        # Laravel-specific configurations
        DirectoryIndex index.php
        
        # Handle Laravel routes
        RewriteEngine On
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule ^(.*)$ index.php/$1 [L]
    </Directory>
    
    # Security headers
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options DENY
    Header always set X-XSS-Protection "1; mode=block"
    
    # Environment-aware Content Security Policy
    # Development environment: Allow Vite HMR and dev server
    SetEnvIf Host "localhost" IS_DEVELOPMENT
    SetEnvIf Host "127.0.0.1" IS_DEVELOPMENT
    SetEnvIf Host ".*\.local$" IS_DEVELOPMENT
    
    # Development CSP - includes Vite dev server for HMR and hot reloading
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' http://localhost:5173 ws://localhost:5173; style-src 'self' 'unsafe-inline' http://localhost:5173; img-src 'self' data: https:; font-src 'self' data: https:; connect-src 'self' http://localhost:5173 ws://localhost:5173; object-src 'none'; base-uri 'self'" env=IS_DEVELOPMENT
    
    # Production CSP - strict policy for compiled assets (no unsafe-inline, no unsafe-eval)
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data: https:; connect-src 'self'; object-src 'none'; base-uri 'self'; frame-ancestors 'none'; form-action 'self'" env=!IS_DEVELOPMENT
    
    # Production-only security headers
    Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" env=!IS_DEVELOPMENT
    
    # Hide Apache signature
    ServerSignature Off
    
    # Logging
    ErrorLog ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined
    
    # Compression
    <Location />
        SetOutputFilter DEFLATE
        SetEnvIfNoCase Request_URI \
            \.(?:gif|jpe?g|png)$ no-gzip dont-vary
        SetEnvIfNoCase Request_URI \
            \.(?:exe|t?gz|zip|bz2|sit|rar)$ no-gzip dont-vary
    </Location>
</VirtualHost>
